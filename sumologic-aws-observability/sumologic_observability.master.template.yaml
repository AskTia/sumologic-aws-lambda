AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: "Sumo Logic Deployment Configuration (Required)"
        Parameters:
          - SumoDeployment
          - SumoAccessID
          - SumoAccessKey
          - RemoveSumoResourcesOnDeleteStack
          - SumoOrganizationId
          - S3BucketPrefix

      - Label:
          default: "Select the Resources that you want to Deploy:"
        Parameters:
          - DynamoDBDeploymentType
          - ALBDeploymentType
          - APIGatewayDeploymentType
          - RDSDeploymentType
          - EC2MetricsDeploymentType
          - LambdaDeploymentType

      - Label:
          default: "AWS Resources Tag Configuration"
        Parameters:
          - AccountAlias
          - AWSRegion

      - Label:
          default: "Sumo Logic Explorer View Tag Configuration"
        Parameters:
          - CreateExplorerView
          - ExplorerName

      - Label:
          default: "AWS EC2 Metrics App Configuration"
        Parameters:
          - Ec2AppSourceCategoryName
          - Ec2CollectorName
          - Ec2SourceName

      - Label:
          default: "AWS ALB App Configuration"
        Parameters:
          - AlbMetricsSourceCategoryName
          - AlbLogsSourceCategoryName
          - AlbCollectorName

      - Label:
          default: "AWS DynamoDB App Configuration"
        Parameters:
          - DynamoDbMetricsSourceCategoryName
          - DynamoDbLogsSourceCategoryName
          - DynamoDbCollectorName

      - Label:
          default: "AWS RDS App Configuration"
        Parameters:
          - RdsAppSourceCategoryName
          - RdsCollectorName

      - Label:
          default: "AWS Lambda App Configuration"
        Parameters:
          - LambdaMetricsSourceCategoryName
          - LambdaLogSourceCategoryName
          - LambdaDataEventsSourceCategoryName
          - LambdaCollectorName

      - Label:
          default: "AWS Api Gateway App Configuration"
        Parameters:
          - ApiGatewayMetricsSourceCategoryName
          - ApiGatewayLogSourceCategoryName
          - ApiGatewayCollectorName

      - Label:
          default: "Sumo Logic Quick Start configuration"
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix

    ParameterLabels:
      SumoDeployment:
        default: "Sumo Logic Deployment Name."
      SumoAccessID:
        default: "Sumo Logic Access ID."
      SumoAccessKey:
        default: "Sumo Logic Access Key."
      RemoveSumoResourcesOnDeleteStack:
        default: "Delete Sumo Logic Resources when stack is deleted."
      SumoOrganizationId:
        default: "Sumo Logic Organization Id."
      S3BucketPrefix:
        default: "Prefix For Your S3 Buckets."
      AWSRegion:
        default: "AWS Region for the resources that need to be tagged."
      AccountAlias:
        default: "Value for Account Tag."
      CreateExplorerView:
        default: "Do you need to create AWS Explorer view in Sumo Logic?"
      ExplorerName:
        default: "Name for AWS Explorer View."

      DynamoDBDeploymentType:
        default: "Do you need to install Resources for AWS Dynamo DB App?"
      ALBDeploymentType:
        default: "Do you need to install Resources for AWS ALB App?"
      APIGatewayDeploymentType:
        default: "Do you need to install Resources for AWS API Gateway App?"
      RDSDeploymentType:
        default: "Do you need to install Resources for AWS RDS App?"
      EC2MetricsDeploymentType:
        default: "Do you need to install Resources for AWS EC2 Metrics App?"
      LambdaDeploymentType:
        default: "Do you need to install Resources for AWS Lambda App?"

      Ec2AppSourceCategoryName:
        default: "EC2 App Metric Data Source Category Name."
      Ec2CollectorName:
        default: "EC2 App Collector Name."
      Ec2SourceName:
        default: "EC2 App MetaData Source Name."

      AlbMetricsSourceCategoryName:
        default: "ALB App Metric Data Source Category Name."
      AlbLogsSourceCategoryName:
        default: "ALB App Logs Data Source Category Name."
      AlbCollectorName:
        default: "ALB App Collector Name."

      DynamoDbMetricsSourceCategoryName:
        default: "Dynamo DB App Metric Data Source Category Name."
      DynamoDbLogsSourceCategoryName:
        default: "Dynamo DB App Logs Data Source Category Name."
      DynamoDbCollectorName:
        default: "Dynamo DB App Collector Name."

      RdsAppSourceCategoryName:
        default: "RDS App Metric Data Source Category Name."
      RdsCollectorName:
        default: "RDS App Collector Name."

      LambdaMetricsSourceCategoryName:
        default: "Lambda App Metric Data Source Category Name."
      LambdaLogSourceCategoryName:
        default: "Lambda App Log Data Source Category Name."
      LambdaDataEventsSourceCategoryName:
        default: "Lambda App Data Events Logs Source Category Name."
      LambdaCollectorName:
        default: "Lambda App Collector Name."

      ApiGatewayMetricsSourceCategoryName:
        default: "Api Gateway App Metric Data Source Category Name."
      ApiGatewayLogSourceCategoryName:
        default: "Api Gateway App Log Data Source Category Name."
      ApiGatewayCollectorName:
        default: "Api Gateway App Collector Name."

      QSS3BucketName:
        default: "Quick Start S3 bucket name."
      QSS3KeyPrefix:
        default: "Quick Start S3 key prefix."

Parameters:
  SumoOrganizationId:
    Description: The Account Overview page displays information about your Sumo Logic organization.
    Type: String
  SumoAccessID:
    Type: String
    Description: The Sumo Logic Access ID.
  SumoAccessKey:
    Type: String
    Description: The Sumo Logic Access Key.
  SumoDeployment:
    Type: String
    AllowedValues:
      - au
      - ca
      - de
      - eu
      - jp
      - us2
      - us1
    Description: "Enter au, ca, de, eu, jp, us2, or us1."
  RemoveSumoResourcesOnDeleteStack:
    AllowedValues:
      - true
      - false
    Default: true
    Description: To delete collector, sources and app when stack is deleted, set this parameter to true. Default is true.
    Type: String
  S3BucketPrefix:
    Type: String
    Description: Provide a unique S3 Bucket prefix. This will be applied to all S3 buckets created using this Quickstart template.

  AccountAlias:
    Type: String
    Description: Provide the Value for Account Tag.
  AWSRegion:
    Type: String
    Default: 'Current Region'
    Description: AWS Region for the resources that need to be tagged.
    AllowedValues:
      - 'Current Region'
      - 'All Regions'

  CreateExplorerView:
    Type: String
    Default: 'Yes'
    Description: Do you need to create AWS Explorer view in Sumo Logic?
    AllowedValues:
      - 'Yes'
      - 'No'
  ExplorerName:
    Type: String
    Default: 'AWS Explorer View'
    Description: Name for AWS Explorer View.

  DynamoDBDeploymentType:
    Type: String
    AllowedValues:
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-S3Bucket"
    Default: "App-SumoResources-S3Bucket"
    Description: "Only-App: Choose this mode if you already have DynamoDB metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting DynamoDB logs. It installs the collector, source and app.
          App-SumoResources-S3Bucket: Choose this mode if you do not have DynamoDB logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket."
  ALBDeploymentType:
    Type: String
    AllowedValues:
      - "Only-AWSTags"
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-AWSTags-S3Bucket"
    Default: "App-SumoResources-AWSTags-S3Bucket"
    Description: "Only-AWSTags: Choose this mode if you need to only tag your AWS Resources.
          Only-App: Choose this mode if you already have metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting logs. It installs the collector, source and app.
          App-SumoResources-AWSTags-S3Bucket: Choose this mode if you do not have logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket and Tags."
  APIGatewayDeploymentType:
    Type: String
    AllowedValues:
      - "Only-AWSTags"
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-AWSTags-S3Bucket"
    Default: "App-SumoResources-AWSTags-S3Bucket"
    Description: "Only-AWSTags: Choose this mode if you need to only tag your AWS Resources.
          Only-App: Choose this mode if you already have metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting logs. It installs the collector, source and app.
          App-SumoResources-AWSTags-S3Bucket: Choose this mode if you do not have logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket and Tags."
  RDSDeploymentType:
    Type: String
    AllowedValues:
      - "Only-AWSTags"
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-AWSTags"
    Default: "App-SumoResources-AWSTags"
    Description: "Only-AWSTags: Choose this mode if you need to only tag your AWS Resources.
          Only-App: Choose this mode if you already have metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting logs. It installs the collector, source and app.
          App-SumoResources-AWSTags: Choose this mode if you do not have logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket and Tags."
  EC2MetricsDeploymentType:
    Type: String
    AllowedValues:
      - "Only-AWSTags"
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-AWSTags"
    Default: "App-SumoResources-AWSTags"
    Description: "Only-AWSTags: Choose this mode if you need to only tag your AWS Resources.
          Only-App: Choose this mode if you already have metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting logs. It installs the collector, source and app.
          App-SumoResources-AWSTags: Choose this mode if you do not have logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket and Tags."
  LambdaDeploymentType:
    Type: String
    AllowedValues:
      - "Only-AWSTags"
      - "Only-App"
      - "App-SumoResources"
      - "App-SumoResources-AWSTags-S3Bucket"
    Default: "App-SumoResources-AWSTags-S3Bucket"
    Description: "Only-AWSTags: Choose this mode if you need to only tag your AWS Resources.
          Only-App: Choose this mode if you already have metrics and logs in Sumo. It installs only the app.
          App-SumoResources: Choose this mode if you already have a S3 bucket which is getting logs. It installs the collector, source and app.
          App-SumoResources-AWSTags-S3Bucket: Choose this mode if you do not have logs and Metrics configured in your AWS Account. It deploys the collector, source, app, s3-bucket and Tags."

  Ec2AppSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/ec2/metrics
  Ec2CollectorName:
    Type: String
    Description: EC2 App Collector Name.
    Default: AWS-Observability-EC2-Collector
  Ec2SourceName:
    Type: String
    Description: EC2 App MetaData Source Name.
    Default: AWS-Observability-EC2-MetaData-Source

  AlbMetricsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/alb/metrics
  AlbLogsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/alb/logs
  AlbCollectorName:
    Type: String
    Description: ALB App Collector Name.
    Default: AWS-Observability-ALB-Collector

  DynamoDbMetricsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/dynamodb/metrics
  DynamoDbLogsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/dynamodb/logs
  DynamoDbCollectorName:
    Type: String
    Description: Dynamo DB App Collector Name.
    Default: AWS-Observability-Dynamo-DB-Collector

  RdsAppSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/rds/metrics
  RdsCollectorName:
    Type: String
    Description: RDS App Collector Name.
    Default: AWS-Observability-RDS-Collector

  LambdaMetricsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/lambda/metrics
  LambdaLogSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/lambda/logs
  LambdaDataEventsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/lambda/dataevents
  LambdaCollectorName:
    Type: String
    Description: Lambda App Collector Name.
    Default: AWS-Observability-Lambda-Collector

  ApiGatewayMetricsSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/apigateway/metrics
  ApiGatewayLogSourceCategoryName:
    Type: String
    Description: Category metadata to use later for querying, e.g. prod/web/apache/access . This data is queried using the '_sourceCategory' key name.
    Default: AWS/apigateway/logs
  ApiGatewayCollectorName:
    Type: String
    Description: API Gateway App Collector Name.
    Default: AWS-Observability-API-Gateway-Collector

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: "sumologicawsobservabilityhelper"
    Description: "S3 bucket name for the Quick Start assets. This string can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: "String"

  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "sumologic-aws-observability/"
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

Conditions:
  region_value: !Equals [!Ref AWSRegion, 'All Regions']
  install_dynamo_db_app: !Or
    - !Equals [ !Ref DynamoDBDeploymentType, "Only-App" ]
    - !Equals [ !Ref DynamoDBDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref DynamoDBDeploymentType, "App-SumoResources-S3Bucket" ]
  install_alb_app: !Or
    - !Equals [ !Ref ALBDeploymentType, "Only-App" ]
    - !Equals [ !Ref ALBDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref ALBDeploymentType, "App-SumoResources-AWSTags-S3Bucket" ]
  install_api_gateway_app: !Or
    - !Equals [ !Ref APIGatewayDeploymentType, "Only-App" ]
    - !Equals [ !Ref APIGatewayDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref APIGatewayDeploymentType, "App-SumoResources-AWSTags-S3Bucket" ]
  install_rds_app: !Or
    - !Equals [ !Ref RDSDeploymentType, "Only-App" ]
    - !Equals [ !Ref RDSDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref RDSDeploymentType, "App-SumoResources-AWSTags" ]
  install_ec2_metrics_app: !Or
    - !Equals [ !Ref EC2MetricsDeploymentType, "Only-App" ]
    - !Equals [ !Ref EC2MetricsDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref EC2MetricsDeploymentType, "App-SumoResources-AWSTags" ]
  install_lambda_app: !Or
    - !Equals [ !Ref LambdaDeploymentType, "Only-App" ]
    - !Equals [ !Ref LambdaDeploymentType, "App-SumoResources" ]
    - !Equals [ !Ref LambdaDeploymentType, "App-SumoResources-AWSTags-S3Bucket" ]
  create_explorer_view: !Equals [!Ref CreateExplorerView, 'Yes']

Resources:

  WaitHandle:
    Type: "AWS::CloudFormation::WaitConditionHandle"

  SumoLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: SumoPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'

  SumoLogicAWSObservabilityHelper:
    Type: 'AWS::Serverless::Function'
    DependsOn: SumoLambdaRole
    Properties:
      Handler: main.handler
      Runtime: python3.7
      CodeUri:
        Bucket: !Sub "${QSS3BucketName}-${AWS::Region}"
        Key: !Sub "${QSS3KeyPrefix}SumoLogicAWSObservabilityHelper/SumoLogicAWSObservabilityHelper.zip"
      MemorySize: 128
      Timeout: 900
      Role:
        Fn::GetAtt:
          - SumoLambdaRole
          - Arn

  SumoRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: arn:aws:iam::926226587429:root
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Sub "${SumoDeployment}:${SumoOrganizationId}"
      Path: "/"
      Policies:
        - PolicyName: SumoPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - tag:GetResources
                Resource:
                  "*"

  TagAWSResources:
    Type: AWS::CloudFormation::Stack
    DependsOn: SumoLogicAWSObservabilityHelper
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/tag_resource.template.yaml"
      Parameters:
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        SumoDeployment: !Ref SumoDeployment
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        AWSRegion: !If [region_value, "all", !Ref "AWS::Region"]
        AccountAlias: !Ref AccountAlias
        AddTagsForALBResources: !Ref ALBDeploymentType
        AddTagsForAPIGatewayResources: !Ref APIGatewayDeploymentType
        AddTagsForRDSResources: !Ref RDSDeploymentType
        AddTagsForEC2MetricsResources: !Ref EC2MetricsDeploymentType
        AddTagsForLambdaResources: !Ref LambdaDeploymentType
        ServiceToken: !GetAtt SumoLogicAWSObservabilityHelper.Arn

  CreateSumoLogicAWSExplorerView:
    Type: Custom::SumoLogicAWSExplorer
    DependsOn: SumoLogicAWSObservabilityHelper
    Condition: create_explorer_view
    Properties:
      ServiceToken: !GetAtt SumoLogicAWSObservabilityHelper.Arn
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      ExplorerName: !Ref ExplorerName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  sumoEC2MetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SumoLogicAWSObservabilityHelper
    Condition: install_ec2_metrics_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/ec2_metrics_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        EC2MetricsDeploymentType: !Ref EC2MetricsDeploymentType
        AWSRegion: !If [region_value, "all", !Ref "AWS::Region"]
        Ec2CollectorName: !Ref Ec2CollectorName
        Ec2SourceName: !Ref Ec2SourceName
        Ec2AppSourceCategoryName: !Ref Ec2AppSourceCategoryName

  sumoAlbMetricsAppStackWaitHandle:
    Condition: install_ec2_metrics_app
    DependsOn: sumoEC2MetricsAppStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoAlbMetricsAppStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [install_ec2_metrics_app, !Ref sumoAlbMetricsAppStackWaitHandle, !Ref WaitHandle]
      Timeout: "10"
      Count: 0

  sumoAlbMetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: [SumoLogicAWSObservabilityHelper, sumoAlbMetricsAppStackWaitCondition]
    Condition: install_alb_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/alb_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        ALBDeploymentType: !Ref ALBDeploymentType
        AlbCollectorName: !Ref AlbCollectorName
        AlbMetricsSourceCategoryName: !Ref AlbMetricsSourceCategoryName
        AlbLogsSourceCategoryName: !Ref AlbLogsSourceCategoryName

  sumoDynamoDBMetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SumoLogicAWSObservabilityHelper
    Condition: install_dynamo_db_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/dynamodb_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        DynamoDBDeploymentType: !Ref DynamoDBDeploymentType
        DynamoDbCollectorName: !Ref DynamoDbCollectorName
        DynamoDbMetricsSourceCategoryName: !Ref DynamoDbMetricsSourceCategoryName
        DynamoDbLogsSourceCategoryName: !Ref DynamoDbLogsSourceCategoryName

  sumoRdsMetricsAppStackWaitHandle:
    Condition: install_dynamo_db_app
    DependsOn: sumoDynamoDBMetricsAppStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoRdsMetricsAppStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [install_dynamo_db_app, !Ref sumoRdsMetricsAppStackWaitHandle, !Ref WaitHandle]
      Timeout: "10"
      Count: 0

  sumoRdsMetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: [SumoLogicAWSObservabilityHelper, sumoRdsMetricsAppStackWaitCondition]
    Condition: install_rds_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/rds_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        RDSDeploymentType: !Ref RDSDeploymentType
        RdsCollectorName: !Ref RdsCollectorName
        RdsAppSourceCategoryName: !Ref RdsAppSourceCategoryName

  sumoLambdaMetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SumoLogicAWSObservabilityHelper
    Condition: install_lambda_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/lambda_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        LambdaDeploymentType: !Ref LambdaDeploymentType
        LambdaCollectorName: !Ref LambdaCollectorName
        LambdaMetricsSourceCategoryName: !Ref LambdaMetricsSourceCategoryName
        LambdaLogSourceCategoryName: !Ref LambdaLogSourceCategoryName
        LambdaDataEventsSourceCategoryName: !Ref LambdaDataEventsSourceCategoryName

  sumoApiGatewayMetricsAppStackWaitHandle:
    Condition: install_lambda_app
    DependsOn: sumoLambdaMetricsAppStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoApiGatewayMetricsAppStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [install_lambda_app, !Ref sumoApiGatewayMetricsAppStackWaitHandle, !Ref WaitHandle]
      Timeout: "10"
      Count: 0

  sumoApiGatewayMetricsAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: [SumoLogicAWSObservabilityHelper, sumoApiGatewayMetricsAppStackWaitCondition]
    Condition: install_api_gateway_app
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}-${AWS::Region}.s3.amazonaws.com/${QSS3KeyPrefix}SupportingTemplates/api_gateway_app.template.yaml"
      Parameters:
        LambdaARN: !GetAtt SumoLogicAWSObservabilityHelper.Arn
        RoleARN: !GetAtt SumoRole.Arn
        SumoDeployment: !Ref SumoDeployment
        SumoAccessID: !Ref SumoAccessID
        SumoAccessKey: !Ref SumoAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
        APIGatewayDeploymentType: !Ref APIGatewayDeploymentType
        ApiGatewayCollectorName: !Ref ApiGatewayCollectorName
        ApiGatewayMetricsSourceCategoryName: !Ref ApiGatewayMetricsSourceCategoryName
        ApiGatewayLogSourceCategoryName: !Ref ApiGatewayLogSourceCategoryName
