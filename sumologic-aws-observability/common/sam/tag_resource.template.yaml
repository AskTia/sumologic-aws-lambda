AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: "Sumo Logic Deployment Configuration (Required)"
        Parameters:
          - RemoveSumoResourcesOnDeleteStack

      - Label:
          default: "AWS Resources Tag Configuration"
        Parameters:
          - AccountAlias

      - Label:
          default: "Select the AWS Resources you want to tag:"
          Parameters:
            - AddTagsForALBResources
            - AddTagsForAPIGatewayResources
            - AddTagsForRDSResources
            - AddTagsForEC2MetricsResources
            - AddTagsForLambdaResources
            - AddTagsForDynamoDBResources

      - Label:
          default: "Filter Regular Expression for tagging resources."
          Parameters:
            - FilterExpression

      - Label:
          default: "Local Parameters. Do Not Edit the values."
          Parameters:
            - ParentStackName

    ParameterLabels:
      RemoveSumoResourcesOnDeleteStack:
        default: "Delete Sumo Logic Resources when stack is deleted."
      AccountAlias:
        default: "Value for Account Tag."
      AddTagsForALBResources:
        default: "Do you need to add Tags for AWS ALB Resources?"
      AddTagsForAPIGatewayResources:
        default: "Do you need to add Tags for AWS API Gateway Resources?"
      AddTagsForRDSResources:
        default: "Do you need to add Tags for AWS RDS Resources?"
      AddTagsForEC2MetricsResources:
        default: "Do you need to add Tags for AWS EC2 Metrics Resources?"
      AddTagsForLambdaResources:
        default: "Do you need to add Tags for AWS Lambda Resources?"
      AddTagsForDynamoDBResources:
        default: "Do you need to add Tags for AWS Dynamo DB Resources?"
      FilterExpression:
        default: "Filter Regular expression"
      ParentStackName:
        default: "If Any, Name of parent Stack."

Parameters:
  RemoveSumoResourcesOnDeleteStack:
    AllowedValues:
      - true
      - false
    Default: true
    Description: To delete collector, sources and app when stack is deleted, set this parameter to true. Default is true.
    Type: String

  AccountAlias:
    Type: String
    Description: Provide the Value for Account Tag.

  AddTagsForALBResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."
  AddTagsForAPIGatewayResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."
  AddTagsForRDSResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."
  AddTagsForEC2MetricsResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."
  AddTagsForLambdaResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."
  AddTagsForDynamoDBResources:
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: "Choose if you need to add tags for your AWS Resources."

  FilterExpression:
    Type: String
    Default: ""
    Description: "Provide regular expression for matching aws resources. For eg;- 'InstanceType': 't1.micro.*?'|'name': 'Test.*?']|'stageName': 'prod.*?'|'FunctionName': 'Test.*?'|TableName.*?|'LoadBalancerName': 'Test.*?'|'DBClusterIdentifier': 'Test.*?'|'DBInstanceIdentifier': 'Test.*?'"

  ParentStackName:
    Type: String
    Default: "ParentStackName"
    Description: Parent Stack Name. Do Not Edit the value.

Conditions:
  add_alb_tags: !Equals [!Ref AddTagsForALBResources, 'Yes']
  add_api_gateway_tags: !Equals [!Ref AddTagsForAPIGatewayResources, 'Yes']
  add_rds_tags: !Equals [!Ref AddTagsForRDSResources, 'Yes']
  add_ec2_metrics_tags: !Equals [!Ref AddTagsForEC2MetricsResources, 'Yes']
  add_lambda_tags: !Equals [!Ref AddTagsForLambdaResources, 'Yes']
  add_dynamodb_tags: !Equals [!Ref AddTagsForDynamoDBResources, 'Yes']
  do_not_use_parent_stack: !Equals [ !Ref ParentStackName, "ParentStackName"]

Resources:

  SumoLambdaRole:
    Type: AWS::IAM::Role
    Condition: do_not_use_parent_stack
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: SumoPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - tag:TagResources
                  - tag:UntagResources
                  - rds:Describe*
                  - rds:*Tag*
                  - apigateway:*
                  - ec2:Describe*
                  - ec2:*Tag*
                  - elasticloadbalancing:*
                  - lambda:List*
                  - lambda:*Tag*
                  - dynamodb:List*
                  - dynamodb:*Tag*
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  SumoLogicAWSObservabilityHelper:
    Type: 'AWS::Serverless::Function'
    DependsOn: SumoLambdaRole
    Condition: do_not_use_parent_stack
    Properties:
      Handler: main.handler
      Runtime: python3.7
      CodeUri:
        Bucket: !Sub "appdevzipfiles-${AWS::Region}"
        Key: !Sub "sumologic-aws-observability/SumoLogicAWSObservabilityHelper/SumoLogicAWSObservabilityHelper.zip"
      MemorySize: 128
      Timeout: 900
      Role:
        Fn::GetAtt:
          - SumoLambdaRole
          - Arn

  TagEc2Resources:
    Type: Custom::TagAWSResources
    Condition: add_ec2_metrics_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: ec2
      AccountID: !Ref "AWS::AccountId"
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias
        namespace: "AWS/EC2"

  TagAlbResources:
    Type: Custom::TagAWSResources
    Condition: add_alb_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: elbv2
      AccountID: !Ref "AWS::AccountId"
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias

  TagApiGatewayResources:
    Type: Custom::TagAWSResources
    Condition: add_api_gateway_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: apigateway
      AccountID: !Ref "AWS::AccountId"
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias

  TagLambdaResources:
    Type: Custom::TagAWSResources
    Condition: add_lambda_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: lambda
      AccountID: !Ref "AWS::AccountId"
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias

  TagRdsResources:
    Type: Custom::TagAWSResources
    Condition: add_rds_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: rds
      AccountID: !Ref "AWS::AccountId"
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias

  TagDynamoDBResources:
    Type: Custom::TagAWSResources
    Condition: add_dynamodb_tags
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicAWSObservabilityHelper
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      Region: !Ref "AWS::Region"
      AWSResource: dynamodb
      Filter: !Ref FilterExpression
      Tags:
        account: !Ref AccountAlias
      AccountID: !Ref "AWS::AccountId"